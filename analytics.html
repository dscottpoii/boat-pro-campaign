<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Analytics - The Boat Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f8fafc;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #0c4a6e 0%, #0284c7 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2em;
        }

        .header .date {
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #0284c7;
        }

        .stat-card.revenue {
            border-left-color: #16a34a;
        }

        .stat-card.roi {
            border-left-color: #f59e0b;
        }

        .stat-card.conversion {
            border-left-color: #8b5cf6;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 800;
            color: #0c4a6e;
            margin-bottom: 8px;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .stat-change.up {
            background: #d1fae5;
            color: #065f46;
        }

        .stat-change.down {
            background: #fee2e2;
            color: #991b1b;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .section h2 {
            color: #0c4a6e;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f1f5f9;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #0c4a6e;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f8fafc;
        }

        .progress-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            background: linear-gradient(90deg, #0284c7, #16a34a);
            height: 100%;
            transition: width 0.3s ease;
        }

        .lead-table {
            max-height: 400px;
            overflow-y: auto;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.lead {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge.premium {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.lifetime {
            background: #d1fae5;
            color: #065f46;
        }

        .export-btn {
            padding: 12px 24px;
            background: #0284c7;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #0c4a6e;
            transform: translateY(-2px);
        }

        .chart-container {
            margin-top: 20px;
            height: 200px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            gap: 10px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .bar {
            background: linear-gradient(to top, #0284c7, #16a34a);
            width: 60px;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: all 0.3s ease;
        }

        .bar:hover {
            opacity: 0.8;
            transform: translateY(-5px);
        }

        .bar-label {
            text-align: center;
            margin-top: 10px;
            font-size: 0.85em;
            color: #666;
        }

        .bar-value {
            position: absolute;
            top: -25px;
            width: 100%;
            text-align: center;
            font-weight: 600;
            color: #0c4a6e;
            font-size: 0.9em;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .filter-btn.active {
            background: #0284c7;
            color: white;
            border-color: #0284c7;
        }

        .filter-btn:hover {
            border-color: #0284c7;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-value {
                font-size: 2em;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <div style="background: #0c4a6e; padding: 12px 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
        <a href="#" onclick="goToHub(); return false;" style="color: white; text-decoration: none; font-weight: 600;">‚Üê Back to Campaign Hub</a>
        <div style="color: white; font-weight: 600;">Analytics Dashboard</div>
        <a href="#" onclick="goToLanding(); return false;" style="color: white; text-decoration: none; font-weight: 600;">Landing Page ‚Üí</a>
    </div>

    <div class="header">
        <div>
            <h1>üìä Campaign Analytics Dashboard</h1>
            <p>The Boat Pro - Winterization Campaign</p>
        </div>
        <div class="date" id="currentDate"></div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Leads</div>
            <div class="stat-value" id="totalLeads">0</div>
            <span class="stat-change up">‚Üë <span id="leadsTrend">0</span> today</span>
        </div>

        <div class="stat-card revenue">
            <div class="stat-label">Revenue Generated</div>
            <div class="stat-value" id="totalRevenue">$0</div>
            <span class="stat-change up">‚Üë <span id="revenueTrend">0</span> memberships</span>
        </div>

        <div class="stat-card roi">
            <div class="stat-label">ROI</div>
            <div class="stat-value" id="roiValue">0%</div>
            <span class="stat-change up">On $3,000 spend</span>
        </div>

        <div class="stat-card conversion">
            <div class="stat-label">Conversion Rate</div>
            <div class="stat-value" id="conversionRate">0%</div>
            <span class="stat-change up">Leads ‚Üí Members</span>
        </div>
    </div>

    <div class="section">
        <h2>Lead to Member Funnel</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div>
                <div style="font-weight: 600; color: #666; margin-bottom: 10px;">Guide Downloads</div>
                <div style="font-size: 2em; font-weight: 700; color: #0284c7;" id="funnelLeads">0</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%"></div>
                </div>
            </div>
            <div>
                <div style="font-weight: 600; color: #666; margin-bottom: 10px;">Pop-Up Views</div>
                <div style="font-size: 2em; font-weight: 700; color: #0284c7;" id="funnelPopup">0</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 80%" id="popupProgress"></div>
                </div>
            </div>
            <div>
                <div style="font-weight: 600; color: #666; margin-bottom: 10px;">Memberships</div>
                <div style="font-size: 2em; font-weight: 700; color: #16a34a;" id="funnelMembers">0</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 20%" id="memberProgress"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Daily Lead Activity</h2>
        <div class="chart-container" id="dailyChart">
            <!-- Chart bars will be generated by JavaScript -->
        </div>
    </div>

    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Recent Activity</h2>
            <button class="export-btn" onclick="exportData()">Export to CSV</button>
        </div>

        <div class="filters">
            <button class="filter-btn active" onclick="filterData('all')">All</button>
            <button class="filter-btn" onclick="filterData('lead')">Leads Only</button>
            <button class="filter-btn" onclick="filterData('membership')">Memberships Only</button>
            <button class="filter-btn" onclick="filterData('premium')">Premium</button>
            <button class="filter-btn" onclick="filterData('lifetime')">Lifetime</button>
        </div>

        <div class="lead-table">
            <table>
                <thead>
                    <tr>
                        <th>Date/Time</th>
                        <th>Name/Email</th>
                        <th>Type</th>
                        <th>Source</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody id="activityTable">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #999;">No activity yet. Data will appear as leads come in.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <h2>Membership Breakdown</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
            <div style="text-align: center; padding: 20px; background: #fef3c7; border-radius: 8px;">
                <div style="font-size: 2.5em; font-weight: 700; color: #92400e;" id="premiumCount">0</div>
                <div style="color: #78350f; font-weight: 600; margin-top: 8px;">Premium Monthly</div>
                <div style="color: #a16207; font-size: 0.9em; margin-top: 5px;" id="premiumRevenue">$0 MRR</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #d1fae5; border-radius: 8px;">
                <div style="font-size: 2.5em; font-weight: 700; color: #065f46;" id="lifetimeCount">0</div>
                <div style="color: #047857; font-weight: 600; margin-top: 8px;">Lifetime</div>
                <div style="color: #059669; font-size: 0.9em; margin-top: 5px;" id="lifetimeRevenue">$0 total</div>
            </div>
        </div>
    </div>

    <script>
        // Navigation functions
        function goToHub() {
            alert('Returning to Campaign Hub...');
            // In production: window.location.href = '/hub.html';
        }

        function goToLanding() {
            alert('Opening Landing Page...');
            // In production: window.location.href = '/landing.html';
        }

        // Set current date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });

        // Load and display all data
        async function loadAnalytics() {
            try {
                const result = await window.storage.get('boat_pro_all_leads');
                const leads = result ? JSON.parse(result.value) : [];

                // Calculate metrics
                const totalLeads = leads.filter(l => l.type === 'lead').length;
                const memberships = leads.filter(l => l.type === 'membership');
                const premiumMembers = memberships.filter(m => m.tier === 'premium').length;
                const lifetimeMembers = memberships.filter(m => m.tier === 'lifetime').length;

                // Calculate revenue
                const premiumRevenue = premiumMembers * 19.99;
                const lifetimeRevenue = lifetimeMembers * 299;
                const totalRevenue = premiumRevenue + lifetimeRevenue;

                // Calculate today's leads
                const today = new Date().toDateString();
                const todayLeads = leads.filter(l => 
                    l.type === 'lead' && new Date(l.timestamp).toDateString() === today
                ).length;

                // Calculate conversion rate
                const conversionRate = totalLeads > 0 ? ((memberships.length / totalLeads) * 100).toFixed(1) : 0;

                // Calculate ROI
                const adSpend = 3000;
                const roi = adSpend > 0 ? (((totalRevenue - adSpend) / adSpend) * 100).toFixed(0) : 0;

                // Update stats
                document.getElementById('totalLeads').textContent = totalLeads;
                document.getElementById('leadsTrend').textContent = todayLeads;
                document.getElementById('totalRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
                document.getElementById('revenueTrend').textContent = memberships.length;
                document.getElementById('roiValue').textContent = `${roi}%`;
                document.getElementById('conversionRate').textContent = `${conversionRate}%`;

                // Update funnel
                document.getElementById('funnelLeads').textContent = totalLeads;
                document.getElementById('funnelPopup').textContent = Math.round(totalLeads * 0.8);
                document.getElementById('funnelMembers').textContent = memberships.length;

                const popupPercent = totalLeads > 0 ? ((totalLeads * 0.8 / totalLeads) * 100) : 0;
                const memberPercent = totalLeads > 0 ? ((memberships.length / totalLeads) * 100) : 0;
                document.getElementById('popupProgress').style.width = `${popupPercent}%`;
                document.getElementById('memberProgress').style.width = `${memberPercent}%`;

                // Update membership breakdown
                document.getElementById('premiumCount').textContent = premiumMembers;
                document.getElementById('premiumRevenue').textContent = `$${premiumRevenue.toFixed(2)} MRR`;
                document.getElementById('lifetimeCount').textContent = lifetimeMembers;
                document.getElementById('lifetimeRevenue').textContent = `$${lifetimeRevenue.toFixed(0)} total`;

                // Generate daily chart
                generateDailyChart(leads);

                // Update activity table
                updateActivityTable(leads);

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        function generateDailyChart(leads) {
            const chartContainer = document.getElementById('dailyChart');
            chartContainer.innerHTML = '';

            // Get last 7 days
            const days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toDateString());
            }

            // Count leads per day
            const dailyCounts = days.map(day => {
                return leads.filter(l => 
                    l.type === 'lead' && new Date(l.timestamp).toDateString() === day
                ).length;
            });

            const maxCount = Math.max(...dailyCounts, 1);

            // Create bars
            days.forEach((day, index) => {
                const count = dailyCounts[index];
                const height = (count / maxCount) * 160;

                const barContainer = document.createElement('div');
                barContainer.style.textAlign = 'center';

                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${height}px`;

                const value = document.createElement('div');
                value.className = 'bar-value';
                value.textContent = count;
                bar.appendChild(value);

                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = new Date(day).toLocaleDateString('en-US', { weekday: 'short' });

                barContainer.appendChild(bar);
                barContainer.appendChild(label);
                chartContainer.appendChild(barContainer);
            });
        }

        function updateActivityTable(leads, filter = 'all') {
            const tbody = document.getElementById('activityTable');

            // Filter leads
            let filteredLeads = leads;
            if (filter !== 'all') {
                if (filter === 'lead') {
                    filteredLeads = leads.filter(l => l.type === 'lead');
                } else if (filter === 'membership') {
                    filteredLeads = leads.filter(l => l.type === 'membership');
                } else if (filter === 'premium' || filter === 'lifetime') {
                    filteredLeads = leads.filter(l => l.type === 'membership' && l.tier === filter);
                }
            }

            // Sort by newest first
            filteredLeads.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (filteredLeads.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No activity for this filter.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredLeads.slice(0, 50).map(lead => {
                const date = new Date(lead.timestamp);
                const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

                let badge = '';
                if (lead.type === 'lead') {
                    badge = '<span class="badge lead">Lead</span>';
                } else if (lead.tier === 'premium') {
                    badge = '<span class="badge premium">Premium</span>';
                } else if (lead.tier === 'lifetime') {
                    badge = '<span class="badge lifetime">Lifetime</span>';
                }

                const value = lead.type === 'membership' ? `$${lead.price}` : '-';
                const nameEmail = lead.firstName && lead.email ? 
                    `${lead.firstName}<br><small style="color: #666;">${lead.email}</small>` : 
                    '-';

                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${nameEmail}</td>
                        <td>${badge}</td>
                        <td>${lead.source || '-'}</td>
                        <td><strong>${value}</strong></td>
                    </tr>
                `;
            }).join('');
        }

        function filterData(filter) {
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Reload data with filter
            loadAnalytics().then(async () => {
                const result = await window.storage.get('boat_pro_all_leads');
                const leads = result ? JSON.parse(result.value) : [];
                updateActivityTable(leads, filter);
            });
        }

        async function exportData() {
            try {
                const result = await window.storage.get('boat_pro_all_leads');
                const leads = result ? JSON.parse(result.value) : [];

                if (leads.length === 0) {
                    alert('No data to export yet!');
                    return;
                }

                // Create CSV
                const headers = ['Date/Time', 'First Name', 'Email', 'Type', 'Tier', 'Price', 'Source'];
                const rows = leads.map(lead => {
                    const date = new Date(lead.timestamp).toLocaleString();
                    return [
                        date,
                        lead.firstName || '',
                        lead.email || '',
                        lead.type || '',
                        lead.tier || '',
                        lead.price || '',
                        lead.source || ''
                    ];
                });

                let csv = headers.join(',') + '\n';
                rows.forEach(row => {
                    csv += row.map(field => `"${field}"`).join(',') + '\n';
                });

                // Download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `boat_pro_campaign_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error exporting:', error);
                alert('Error exporting data');
            }
        }

        // Load analytics on page load
        loadAnalytics();

        // Refresh every 30 seconds
        setInterval(loadAnalytics, 30000);
    </script>
</body>
</html>
